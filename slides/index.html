<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Arc&lt;Mutex&lt;T&gt;&gt;</title>

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/solarized.css">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/solarized-dark.css">

        <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">

        <style>
            tt {
                background-color: #eee8d5;
                padding: 0 .1em;
                border-radius: .2em;
                font-family: 'Ubuntu Mono', monospace;
                text-transform: none;
            }
            .reveal pre {
                width: 50%;
                font-size: 24pt;
            }
            .reveal pre code {
                font-family: 'Ubuntu Mono', monospace;
                max-height: none;
                overflow: hidden;
            }
            .reveal pre ::selection {
                color: #657b83;
                background: #fdf6e3;
            }
            .column_container {
                display: grid;
                grid-auto-flow: column;
                grid-auto-columns: 50%;
            }
            .column {
            }
            .column pre {
                width: 95%;
            }
        </style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">

<!-- --------------------------------------------------------- -->

<section>
    <h1><tt>Arc&lt;Mutex&lt;T&gt;&gt;</tt></h1>
    <h2>And the syntactic sugar of <tt>Deref</tt></h2>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <section data-markdown>
        <textarea data-template>
            Things you need some prior experience with:

            - <tt>Vec\<T\></tt>
            - <tt>Result\<T, E\></tt> and <tt>.unwrap()</tt>
            - <tt>\&T</tt> and <tt>\&mut T</tt>
            - closures, for example <tt>|x| x + 1</tt>
            - traits, for example <tt>Clone</tt> and <tt>Add</tt>
            - threads and locks (in any language)

            You can learn these things from:

            - [The Book](https://doc.rust-lang.org/stable/book/)
            - [Rust by Example](https://doc.rust-lang.org/rust-by-example/)
            - [Rustlings](https://github.com/rust-lang/rustlings/)
        </textarea>
    </section>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">The code</a>
    <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let output = Arc::new(Mutex::new(Vec::new()));
    let output_clone = output.clone();
    thread::spawn(move || fill_vector(&output_clone));
    loop {
        println!("{:?}", output.lock().unwrap());
        thread::sleep(Duration::from_millis(100));
    }
}

fn fill_vector(output: &Mutex<Vec<u64>>) {
    for i in 0.. {
        output.lock().unwrap().push(i);
        thread::sleep(Duration::from_secs(1));
    }
}
</script></code>
    </pre>
</section>

<!-- --------------------------------------------------------- -->

<section>
    Side-by-side with Python

    <p>talk about what arc is here?</p>

    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">Rust</a>
            <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let output = Arc::new(Mutex::new(Vec::new()));
    let output_clone = output.clone();
    thread::spawn(move || fill_vector(&output_clone));
    loop {
        println!("{:?}", output.lock().unwrap());
        thread::sleep(Duration::from_millis(100));
    }
}

fn fill_vector(output: &Mutex<Vec<u64>>) {
    for i in 0.. {
        output.lock().unwrap().push(i);
        thread::sleep(Duration::from_secs(1));
    }
}
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/original.py">Python</a>
            <pre class="python">
<code data-trim><script type="text/template">
import threading
import time

def main():
    output = []
    mutex = threading.Lock()
    threading.Thread(
        target=fill_vector,
        args=(output, mutex),
        daemon=True,
    ).start()
    while True:
        with mutex:
            print(output)
        time.sleep(0.1)

def fill_vector(output, mutex):
    for i in range(2**64):
        with mutex:
            output.append(i)
        time.sleep(1)
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
    Removing syntactic sugar
    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">original</a>
            <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let output = Arc::new(Mutex::new(Vec::new()));
    let output_clone = output.clone();
    thread::spawn(move || fill_vector(&output_clone));
    loop {
        println!("{:?}", output.lock().unwrap());
        thread::sleep(Duration::from_millis(100));
    }
}

fn fill_vector(output: &Mutex<Vec<u64>>) {
    for i in 0.. {
        output.lock().unwrap().push(i);
        thread::sleep(Duration::from_secs(1));
    }
}
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/desugared.rs">desugared</a>
            <pre class="rust" style="font-size: 14pt">
<code data-trim><script type="text/template">
use std::ops::{Deref, DerefMut, RangeFrom};
use std::sync::{Arc, Mutex, MutexGuard};
use std::thread;
use std::time::Duration;

use std::clone::Clone;
use std::iter::IntoIterator;
use std::iter::Iterator;
use std::option::Option::Some;
use std::result::Result;
use std::vec::Vec;

fn main() {
    let output = Arc::new(Mutex::new(Vec::new()));
    let output_clone = output.clone();
    thread::spawn(|| {
        let moved_clone = output_clone;
        let mutex_ref: &Mutex<Vec<u64>> = moved_clone.deref();
        fill_vector(mutex_ref);
    });
    loop {
        let mutex: &Mutex<Vec<u64>> = output.deref();
        let lock_result: Result<MutexGuard<Vec<u64>>, _> = mutex.lock();
        let guard: MutexGuard<Vec<u64>> = lock_result.unwrap();
        // let v: &Vec<u64> = guard.deref();
        println!("{:?}", guard);
        drop(guard);
        thread::sleep(Duration::from_millis(100));
    }
}

fn fill_vector(output: &Mutex<Vec<u64>>) {
    let range: RangeFrom<u64> = 0..;
    let mut iterator = range.into_iter();
    while let Some(i) = iterator.next() {
        let lock_result: Result<MutexGuard<Vec<u64>>, _> = output.lock();
        let mut guard: MutexGuard<Vec<u64>> = lock_result.unwrap();
        let v: &mut Vec<u64> = guard.deref_mut();
        v.push(i);
        drop(guard);
        thread::sleep(Duration::from_secs(1));
    }
}
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
    Imports and the prelude

    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">original</a>
            <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/desugared.rs">desugared</a>
            <pre class="rust">
<code data-trim><script type="text/template">
use std::ops::{Deref, DerefMut, RangeFrom};
use std::sync::{Arc, Mutex, MutexGuard};
use std::thread;
use std::time::Duration;

use std::clone::Clone;
use std::iter::IntoIterator;
use std::iter::Iterator;
use std::option::Option::Some;
use std::result::Result;
use std::vec::Vec;
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <tt>main</tt>
    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">original</a>
            <pre class="rust">
<code data-trim><script type="text/template">
fn main() {
    let output = Arc::new(Mutex::new(Vec::new()));
    let output_clone = output.clone();
    thread::spawn(move || fill_vector(&output_clone));
    loop {
        println!("{:?}", output.lock().unwrap());
        thread::sleep(Duration::from_millis(100));
    }
}
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/desugared.rs">desugared</a>
            <pre class="rust">
<code data-trim><script type="text/template">
fn main() {
    let output = Arc::new(Mutex::new(Vec::new()));
    let output_clone = output.clone();
    thread::spawn(|| {
        let moved_clone = output_clone;
        let mutex_ref: &Mutex<Vec<u64>> =
            moved_clone.deref();
        fill_vector(mutex_ref);
    });
    loop {
        let mutex: &Mutex<Vec<u64>> = output.deref();
        let lock_result: Result<MutexGuard<_>, _> =
            mutex.lock();
        let guard: MutexGuard<Vec<u64>> =
            lock_result.unwrap();
        // let v: &Vec<u64> = guard.deref();
        println!("{:?}", guard);
        drop(guard);
        thread::sleep(Duration::from_millis(100));
    }
}
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <tt>fill_vector</tt>
    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">original</a>
            <pre class="rust">
<code data-trim><script type="text/template">
fn fill_vector(output: &Mutex<Vec<u64>>) {
    for i in 0.. {
        output.lock().unwrap().push(i);
        thread::sleep(Duration::from_secs(1));
    }
}
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/desugared.rs">desugared</a>
            <pre class="rust">
<code data-trim><script type="text/template">
fn fill_vector(output: &Mutex<Vec<u64>>) {
    let range: RangeFrom<u64> = 0..;
    let mut iterator = range.into_iter();
    while let Some(i) = iterator.next() {
        let lock_result: Result<MutexGuard<Vec<u64>>, _> =
            output.lock();
        let mut guard: MutexGuard<Vec<u64>> =
            lock_result.unwrap();
        let v: &mut Vec<u64> = guard.deref_mut();
        v.push(i);
        drop(guard);
        thread::sleep(Duration::from_secs(1));
    }
}
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
Arc and lifetimes

<p>

<iframe src="https://doc.rust-lang.org/std/thread/fn.spawn.html" width=1000 height=800></iframe>
</section>

<!-- --------------------------------------------------------- -->

<section>
Send and Sync
</section>

<!-- --------------------------------------------------------- -->

<section>
Crossbeam scope

and the pre-1.0 scope story
</section>

<!-- --------------------------------------------------------- -->

<section>
Lazy

globals are unsafe
Vec::new() is const
</section>

<!-- --------------------------------------------------------- -->

<section>
What is Python doing exactly?

automatic reference counting
the GIL
</section>

<!-- --------------------------------------------------------- -->

            </div>
        </div>

        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/
            Reveal.initialize({
                hash: true,
                transition: "none",
                progress: false,
                width: 1920,
                height: 1080,

                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
            });
        </script>
    </body>
</html>
