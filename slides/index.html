<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Arc&lt;Mutex&lt;T&gt;&gt;</title>

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/solarized.css">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/solarized-dark.css">

        <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet">

        <style>
            tt {
                background-color: #eee8d5;
                padding: 0 .1em;
                border-radius: .2em;
                font-family: 'Ubuntu Mono', monospace;
                text-transform: none;
            }
            .reveal pre {
                width: 50%;
                font-size: 24pt;
            }
            .reveal pre code {
                font-family: 'Ubuntu Mono', monospace;
                max-height: none;
                overflow: hidden;
            }
            .reveal pre ::selection {
                color: #657b83;
                background: #fdf6e3;
            }
            .column_container {
                display: grid;
                grid-auto-flow: column;
                grid-auto-columns: 50%;
            }
            .column {
            }
            .column pre {
                width: 95%;
            }
        </style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">

<!-- --------------------------------------------------------- -->

<section>
    <h1><tt>Arc&lt;Mutex&lt;T&gt;&gt;</tt></h1>
    <h2>And the syntactic sugar of <tt>Deref</tt></h2>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <section data-markdown>
        <textarea data-template>
            Things you need some prior experience with:

            - <tt>Vec\<T\></tt>
            - <tt>Result\<T, E\></tt> and <tt>.unwrap()</tt>
            - <tt>\&T</tt> and <tt>\&mut T</tt>
            - closures, for example <tt>|x| x + 1</tt>
            - traits, for example <tt>Clone</tt> and <tt>Add</tt>
            - threads and locks (in any language)

            You can learn these things from:

            - [The Book](https://doc.rust-lang.org/stable/book/)
            - [Rust by Example](https://doc.rust-lang.org/rust-by-example/)
            - [Rustlings](https://github.com/rust-lang/rustlings/)
        </textarea>
    </section>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">the code</a>
    <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let number = Arc::new(Mutex::new(0u64));
    let alias = number.clone();
    thread::spawn(move || add_loop(&alias));
    loop {
        println!("{}", *number.lock().unwrap());
        thread::sleep(Duration::from_secs(1));
    }
}

fn add_loop(number: &Mutex<u64>) {
    loop {
        *number.lock().unwrap() += 1;
    }
}
</script></code>
    </pre>
</section>

<!-- --------------------------------------------------------- -->

<section>
    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">the code</a>
            <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let number = Arc::new(Mutex::new(0u64));
    let alias = number.clone();
    thread::spawn(move || add_loop(&alias));
    loop {
        println!("{}", *number.lock().unwrap());
        thread::sleep(Duration::from_secs(1));
    }
}

fn add_loop(number: &Mutex<u64>) {
    loop {
        *number.lock().unwrap() += 1;
    }
}
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/original.py">similar Python</a>
            <pre class="python">
<code data-trim><script type="text/template">
import threading
import time

def main():
    number = [0]
    mutex = threading.Lock()
    threading.Thread(
        target=add_loop,
        args=(number, mutex),
    ).start()
    while True:
        with mutex:
            print(number[0])
        time.sleep(1)

def add_loop(number, mutex):
    while True:
        with mutex:
            number[0] += 1
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
    What is Arc?
</section>

<!-- --------------------------------------------------------- -->

<section>
    Removing syntactic sugar
    <div class="column_container">
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/original.rs">original</a>
            <pre class="rust">
<code data-trim><script type="text/template">
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn main() {
    let number = Arc::new(Mutex::new(0u64));
    let alias = number.clone();
    thread::spawn(move || add_loop(&alias));
    loop {
        println!("{}", *number.lock().unwrap());
        thread::sleep(Duration::from_secs(1));
    }
}

fn add_loop(number: &Mutex<u64>) {
    loop {
        *number.lock().unwrap() += 1;
    }
}
</script></code>
            </pre>
        </div>
        <div class="column">
            <a href="https://github.com/oconnor663/arc_mutex_talk/blob/main/src/bin/desugared.rs">desugared</a>
            <pre class="rust" style="font-size: 18pt">
<code data-trim><script type="text/template">
use std::ops::{Deref, DerefMut};
use std::sync::{Arc, Mutex, MutexGuard};
use std::thread;
use std::time::Duration;

fn main() {
    let number: Arc<Mutex<u64>> = Arc::new(Mutex::new(0u64));
    let alias: Arc<Mutex<u64>> = number.clone();
    thread::spawn(|| {
        let moved: Arc<Mutex<u64>> = alias;
        let mutex: &Mutex<u64> = moved.deref();
        add_loop(mutex);
    });
    loop {
        let mutex: &Mutex<u64> = number.deref();
        let guard: MutexGuard<u64> = mutex.lock().unwrap();
        let number_ref: &u64 = guard.deref();
        println!("{}", *number_ref);
        drop(guard);
        thread::sleep(Duration::from_secs(1));
    }
}

fn add_loop(number: &Mutex<u64>) {
    loop {
        let mut guard: MutexGuard<u64> = number.lock().unwrap();
        let number_mut: &mut u64 = guard.deref_mut();
        *number_mut += 1;
        drop(guard);
    }
}
</script></code>
            </pre>
        </div>
    </div>
</section>

<!-- --------------------------------------------------------- -->

<section>
    Where have we seen this before?

    <pre class="rust">
<code data-trim><script type="text/template">
fn take_a_slice(s: &[i32]) {
    dbg!(s.len());
}

fn take_a_str(s: &str) {
    dbg!(s.len());
}

fn main() {
    let my_vec: Vec<i32> = vec![1, 2, 3];
    take_a_slice(&my_vec);

    let my_string: String = "foo".into();
    take_a_str(&my_string);
}
</script></code>
    </pre>

</section>

<!-- --------------------------------------------------------- -->

<section>
Arc and lifetimes

<p>

</section>

<!-- --------------------------------------------------------- -->

<section>
Send and Sync
</section>

<!-- --------------------------------------------------------- -->

<section>
Crossbeam scope

and the pre-1.0 scope story
</section>

<!-- --------------------------------------------------------- -->

<section>
Lazy

globals are unsafe
Vec::new() is const
</section>

<!-- --------------------------------------------------------- -->

<section>
What is Python doing exactly?

automatic reference counting
the GIL
</section>

<!-- --------------------------------------------------------- -->

            </div>
        </div>

        <script src="dist/reveal.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/
            Reveal.initialize({
                hash: true,
                transition: "none",
                progress: false,
                width: 1920,
                height: 1080,

                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
            });
        </script>
    </body>
</html>
